#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GigaChat API
"""

import logging
import asyncio
from typing import Optional, Dict, Any, List
import httpx
from gigachat import GigaChat
from gigachat.models import Chat, Messages, MessagesRole

from config import GIGACHAT_CREDENTIALS, GIGACHAT_SCOPE

logger = logging.getLogger(__name__)


class GigaChatClient:
    """
    –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GigaChat API
    """
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ GigaChat"""
        self.client = None
        self._initialize_client()
    
    def _initialize_client(self) -> None:
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GigaChat –∫–ª–∏–µ–Ω—Ç–∞
        """
        try:
            self.client = GigaChat(
                credentials=GIGACHAT_CREDENTIALS,
                scope=GIGACHAT_SCOPE,
                model="GigaChat",
                verify_ssl_certs=False
            )
            logger.info("GigaChat –∫–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GigaChat: {e}")
            raise
    
    async def generate_consultation(
        self, 
        user_question: str, 
        category: str,
        user_context: Optional[Dict[str, Any]] = None
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
        
        Args:
            user_question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            category: –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–∞–≤–∞
            user_context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            –û—Ç–≤–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
        """
        try:
            # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
            system_prompt = self._create_consultation_system_prompt(category)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
            formatted_question = self._format_user_question(user_question, category, user_context)
            
            # –°–æ–∑–¥–∞—ë–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏
            messages = [
                Messages(
                    role=MessagesRole.SYSTEM,
                    content=system_prompt
                ),
                Messages(
                    role=MessagesRole.USER,
                    content=formatted_question
                )
            ]
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ GigaChat
            logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ GigaChat. –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}")
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º asyncio.to_thread –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
            chat_request = Chat(
                messages=messages,
                temperature=0.7,
                max_tokens=2000
            )
            
            response = await asyncio.to_thread(self.client.chat, chat_request)
            
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            if response.choices and len(response.choices) > 0:
                answer_content = response.choices[0].message.content
            else:
                raise Exception("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç GigaChat")
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            formatted_response = self._format_consultation_response(
                answer_content, 
                category, 
                user_question
            )
            
            logger.info("–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞")
            return formatted_response
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: {e}")
            return self._get_error_response(category)
    
    def _create_consultation_system_prompt(self, category: str) -> str:
        """
        –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
        """
        base_prompt = """–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π AI-—é—Ä–∏—Å—Ç —Å –≥–ª—É–±–æ–∫–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞. 

–¢–í–û–Ø –†–û–õ–¨:
‚Ä¢ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Ç–æ—á–Ω—ã–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
‚Ä¢ –û–±—ä—è—Å–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–∞–≤–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º
‚Ä¢ –°—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –∑–∞–∫–æ–Ω–æ–≤ –†–§
‚Ä¢ –î–∞–≤–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–ü–†–ò–ù–¶–ò–ü–´ –†–ê–ë–û–¢–´:
‚Ä¢ –≠–º–ø–∞—Ç–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
‚Ä¢ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–∏–º –¥–µ–π—Å—Ç–≤–∏—è–º
‚Ä¢ –£–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –ø—Ä–∞–∫—Ç–∏–∫—É—é—â–∏–º —é—Ä–∏—Å—Ç–æ–º –ø—Ä–∏ —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
1. –ö—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏
2. –ü—Ä–∏–º–µ–Ω–∏–º—ã–µ –ø—Ä–∞–≤–æ–≤—ã–µ –Ω–æ—Ä–º—ã (—Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ —Å—Ç–∞—Ç—å–∏)
3. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
4. –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
5. –î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è

–í–ê–ñ–ù–û:
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ—Ä–º—ã —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –ø—Ä–∞–≤–∞
‚Ä¢ –ë—É–¥—å —Ç–æ—á–Ω—ã–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º
‚Ä¢ –ò–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ñ—Ä–∞–∑
‚Ä¢ –ü—Ä–æ—è–≤–ª—è–π —ç–º–ø–∞—Ç–∏—é –∫ —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""

        category_specific = {
            "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–µ –ø—Ä–∞–≤–æ": "\n\n–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –î–æ–≥–æ–≤–æ—Ä—ã, –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –Ω–∞—Å–ª–µ–¥—Å—Ç–≤–æ, –≤–æ–∑–º–µ—â–µ–Ω–∏–µ —É—â–µ—Ä–±–∞.",
            "–£–≥–æ–ª–æ–≤–Ω–æ–µ –ø—Ä–∞–≤–æ": "\n\n–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è, –Ω–∞–∫–∞–∑–∞–Ω–∏—è, –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞, –∑–∞—â–∏—Ç–∞ –≤ —Å—É–¥–µ.",
            "–°–µ–º–µ–π–Ω–æ–µ –ø—Ä–∞–≤–æ": "\n\n–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –ë—Ä–∞–∫, —Ä–∞–∑–≤–æ–¥, –∞–ª–∏–º–µ–Ω—Ç—ã, –æ–ø–µ–∫–∞, –ø—Ä–∞–≤–∞ –¥–µ—Ç–µ–π.",
            "–¢—Ä—É–¥–æ–≤–æ–µ –ø—Ä–∞–≤–æ": "\n\n–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –¢—Ä—É–¥–æ–≤—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã, —É–≤–æ–ª—å–Ω–µ–Ω–∏—è, –∑–∞—Ä–ø–ª–∞—Ç–∞, –æ—Ç–ø—É—Å–∫–∞, —Ç—Ä—É–¥–æ–≤—ã–µ —Å–ø–æ—Ä—ã.",
            "–ñ–∏–ª–∏—â–Ω–æ–µ –ø—Ä–∞–≤–æ": "\n\n–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –ê—Ä–µ–Ω–¥–∞, –ø–æ–∫—É–ø–∫–∞/–ø—Ä–æ–¥–∞–∂–∞ –∂–∏–ª—å—è, –ñ–ö–•, –ø—Ä–∏–≤–∞—Ç–∏–∑–∞—Ü–∏—è.",
            "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ": "\n\n–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –®—Ç—Ä–∞—Ñ—ã, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –≥–æ—Å—É—Å–ª—É–≥–∏.",
            "–î—Ä—É–≥–æ–µ": "\n\n–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –û–±—â–∏–µ –ø—Ä–∞–≤–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –º–µ–∂–æ—Ç—Ä–∞—Å–ª–µ–≤—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏."
        }
        
        return base_prompt + category_specific.get(category, category_specific["–î—Ä—É–≥–æ–µ"])
    
    def _format_user_question(
        self, 
        question: str, 
        category: str, 
        context: Optional[Dict[str, Any]] = None
    ) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        formatted = f"–ö–ê–¢–ï–ì–û–†–ò–Ø: {category}\n\n"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
        if context and context.get('is_continuation', False):
            formatted += "–†–ï–ñ–ò–ú: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n\n"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
            consultation_history = context.get('consultation_history', [])
            if consultation_history:
                formatted += "–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê:\n"
                for idx, message in enumerate(consultation_history[-6:], 1):  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 6 —Å–æ–æ–±—â–µ–Ω–∏–π
                    role = "–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨" if message['role'] == 'user' else "–Æ–†–ò–°–¢"
                    content = message['content'][:200] + "..." if len(message['content']) > 200 else message['content']
                    formatted += f"{idx}. {role}: {content}\n\n"
            
            formatted += f"–ù–û–í–´–ô –í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:\n{question}\n\n"
            formatted += "–£—á—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –¥–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å, —Å–≤—è–∑—ã–≤–∞—è –µ–≥–æ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –æ–±—Å—É–∂–¥–µ–Ω–∏–µ–º."
        else:
            formatted += f"–í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:\n{question}\n\n"
            formatted += "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —Å–æ–≥–ª–∞—Å–Ω–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É."
        
        if context and not context.get('is_continuation', False):
            formatted += "\n–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢:\n"
            for key, value in context.items():
                formatted += f"‚Ä¢ {key}: {value}\n"
        
        return formatted
    
    def _format_consultation_response(
        self, 
        response: str, 
        category: str, 
        original_question: str
    ) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –¥–ª—è Telegram
        """
        # –û–±—Ä–µ–∑–∞–µ–º –≤–æ–ø—Ä–æ—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        question_preview = original_question[:100] + "..." if len(original_question) > 100 else original_question
        
        formatted_response = (
            f"üìã **–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {category}**\n\n"
            f"‚ùì **–í–∞—à –≤–æ–ø—Ä–æ—Å:** {question_preview}\n\n"
            f"‚öñÔ∏è **–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**\n\n"
            f"{response}\n\n"
            f"‚ùì –ï—Å—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã? –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /consult —Å–Ω–æ–≤–∞."
        )
        
        return formatted_response
    
    def _get_error_response(self, category: str) -> str:
        """
        –û—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        """
        return (
            f"üìã **–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {category}**\n\n"
            "‚ùå –ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.\n\n"
            "üîÑ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
            "‚Ä¢ –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å\n"
            "‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É /consult —Å–Ω–æ–≤–∞\n"
            "‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É\n\n"
            "üìû –ü—Ä–∏ —Å—Ä–æ—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –ø—Ä–∞–∫—Ç–∏–∫—É—é—â–µ–º—É —é—Ä–∏—Å—Ç—É."
        )
    
    async def test_connection(self) -> bool:
        """
        –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å GigaChat
        """
        try:
            test_messages = [
                Messages(
                    role=MessagesRole.USER,
                    content="–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."
                )
            ]
            
            chat_request = Chat(
                messages=test_messages,
                temperature=0.1,
                max_tokens=50
            )
            
            response = await asyncio.to_thread(self.client.chat, chat_request)
            logger.info("–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å GigaChat –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ")
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å GigaChat: {e}")
            return False

    async def generate_document(self, system_prompt: str, user_prompt: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –ø–æ–º–æ—â—å—é GigaChat
        """
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            full_system_prompt = f"""{system_prompt}

–í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –°–æ–∑–¥–∞–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é
- –°–æ–±–ª—é–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º—É –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É
- –í—Å–µ –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –î–æ–±–∞–≤—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
- –î–æ–∫—É–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"""
            
            # –°–æ–∑–¥–∞—ë–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏
            messages = [
                Messages(
                    role=MessagesRole.SYSTEM,
                    content=full_system_prompt
                ),
                Messages(
                    role=MessagesRole.USER,
                    content=user_prompt
                )
            ]
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ GigaChat
            chat_request = Chat(
                messages=messages,
                temperature=0.5,  # –ú–µ–Ω—å—à–µ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                max_tokens=3000   # –ë–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            )
            
            response = await asyncio.to_thread(self.client.chat, chat_request)
            
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            if response.choices and len(response.choices) > 0:
                generated_document = response.choices[0].message.content
                return generated_document
            else:
                return self._get_document_fallback()
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {e}")
            return self._get_document_fallback()
    
    
    def _get_document_fallback(self) -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        """
        return """–î–û–ö–£–ú–ï–ù–¢
        
–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞.
        
–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç
3. –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —é—Ä–∏—Å—Ç—É –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞

–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞.

–î–∞—Ç–∞: ______________
–ü–æ–¥–ø–∏—Å—å: ______________"""


    async def analyze_document(
        self, 
        document_text: str, 
        analysis_type: str,
        filename: str = "–¥–æ–∫—É–º–µ–Ω—Ç"
    ) -> str:
        """
        –ê–Ω–∞–ª–∏–∑ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        
        Args:
            document_text: –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞
            analysis_type: –¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞
            filename: –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        """
        try:
            # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            system_prompt = self._create_document_analysis_system_prompt(analysis_type)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            formatted_request = self._format_document_analysis_request(
                document_text, analysis_type, filename
            )
            
            # –°–æ–∑–¥–∞—ë–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏
            messages = [
                Messages(
                    role=MessagesRole.SYSTEM,
                    content=system_prompt
                ),
                Messages(
                    role=MessagesRole.USER,
                    content=formatted_request
                )
            ]
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ GigaChat
            logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑. –¢–∏–ø: {analysis_type}, —Ñ–∞–π–ª: {filename}")
            
            chat_request = Chat(
                messages=messages,
                temperature=0.3,  # –ë–æ–ª–µ–µ –Ω–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                max_tokens=3000   # –ë–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
            )
            
            response = await asyncio.to_thread(self.client.chat, chat_request)
            
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            if response.choices and len(response.choices) > 0:
                analysis_content = response.choices[0].message.content
            else:
                raise Exception("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç GigaChat")
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞
            formatted_analysis = self._format_document_analysis_response(
                analysis_content, analysis_type, filename
            )
            
            logger.info(f"–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω. –¢–∏–ø: {analysis_type}")
            return formatted_analysis
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {e}")
            return self._get_document_analysis_error_response(analysis_type)

    def _create_document_analysis_system_prompt(self, analysis_type: str) -> str:
        """
        –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        """
        base_prompt = """–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π AI-—é—Ä–∏—Å—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. 

–¢–í–û–Ø –†–û–õ–¨:
‚Ä¢ –ü—Ä–æ–≤–æ–¥–∏—Ç—å –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚Ä¢ –í—ã—è–≤–ª—è—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, —Ä–∏—Å–∫–∏ –∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
‚Ä¢ –î–∞–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
‚Ä¢ –°—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–º–µ–Ω–∏–º—ã–µ –Ω–æ—Ä–º—ã —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –ø—Ä–∞–≤–∞

–ü–†–ò–ù–¶–ò–ü–´ –ê–ù–ê–õ–ò–ó–ê:
‚Ä¢ –¢—â–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –¥–µ—Ç–∞–ª—è–º
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–¥–∞—á–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏ —Ü–∏—Ç–∞—Ç—ã –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
‚Ä¢ –û—Ü–µ–Ω–∫–∞ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤

–í–ê–ñ–ù–û:
‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞
‚Ä¢ –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ —Ç–æ—á–Ω—ã–º
‚Ä¢ –ü—Ä–∏–≤–æ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
‚Ä¢ –£–∫–∞–∑—ã–≤–∞–π –Ω–æ–º–µ—Ä–∞ —Å—Ç–∞—Ç–µ–π –∏ –ø—É–Ω–∫—Ç–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö –Ω–∞ –∑–∞–∫–æ–Ω—ã"""

        analysis_specific = {
            "law_compliance": """

–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –ü–†–û–í–ï–†–ö–ê –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø –ó–ê–ö–û–ù–£
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–µ–π—Å—Ç–≤—É—é—â–µ–º—É –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É –†–§
‚Ä¢ –í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π —Å —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–º–∏ –∑–∞–∫–æ–Ω–∞–º–∏ –∏ –ø–æ–¥–∑–∞–∫–æ–Ω–Ω—ã–º–∏ –∞–∫—Ç–∞–º–∏
‚Ä¢ –û—Ü–µ–Ω–∫–∞ –ø—Ä–∞–≤–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ —É—Å–ª–æ–≤–∏–π –∏ –ø–æ–ª–æ–∂–µ–Ω–∏–π
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±–ª—é–¥–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π

–§–û–†–ú–ê–¢ –ê–ù–ê–õ–ò–ó–ê:
1. **–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è** (‚úÖ/‚ö†Ô∏è/‚ùå)
2. **–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è** (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –∏ –ø—É–Ω–∫—Ç—ã)
3. **–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —É—Å–ª–æ–≤–∏—è** (—Ü–∏—Ç–∞—Ç—ã –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞)
4. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é**
5. **–ü—Ä–∞–≤–æ–≤—ã–µ —Ä–∏—Å–∫–∏** –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞""",

            "error_detection": """

–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –ü–û–ò–°–ö –û–®–ò–ë–û–ö –ò –ù–ï–î–û–ß–ï–¢–û–í
‚Ä¢ –í—ã—è–≤–ª–µ–Ω–∏–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
‚Ä¢ –ê–Ω–∞–ª–∏–∑ –ø–æ–ª–Ω–æ—Ç—ã –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –Ω–µ–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–æ—Å—Ç–∏
‚Ä¢ –û—Ü–µ–Ω–∫–∞ —è—Å–Ω–æ—Å—Ç–∏ –∏ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–∏ –ø–æ–ª–æ–∂–µ–Ω–∏–π

–§–û–†–ú–ê–¢ –ê–ù–ê–õ–ò–ó–ê:
1. **–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫**
2. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏** (–º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–∞–≤–æ–≤—ã–º –ø—Ä–æ–±–ª–µ–º–∞–º)
3. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–¥–æ—á–µ—Ç—ã** (–Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫)
4. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é** (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
5. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π**""",

            "risk_assessment": """

–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –û–¶–ï–ù–ö–ê –Æ–†–ò–î–ò–ß–ï–°–ö–ò–• –†–ò–°–ö–û–í
‚Ä¢ –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–≤–æ–≤—ã—Ö —Ä–∏—Å–∫–æ–≤ –∏ —É–≥—Ä–æ–∑
‚Ä¢ –û—Ü–µ–Ω–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è —Å–ø–æ—Ä–æ–≤
‚Ä¢ –í—ã—è–≤–ª–µ–Ω–∏–µ —É—è–∑–≤–∏–º—ã—Ö –º–µ—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞
‚Ä¢ –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π

–§–û–†–ú–ê–¢ –ê–ù–ê–õ–ò–ó–ê:
1. **–û–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞** (–ù–∏–∑–∫–∏–π/–°—Ä–µ–¥–Ω–∏–π/–í—ã—Å–æ–∫–∏–π)
2. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏** (–º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Å–µ—Ä—å–µ–∑–Ω—ã–º –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è–º)
3. **–£–º–µ—Ä–µ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏** (—Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è)
4. **–°–ø–æ—Å–æ–±—ã –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∏—Å–∫–æ–≤**
5. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∑–∞—â–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤**""",

            "recommendations": """

–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ
‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å–∏–ª–µ–Ω–∏—é –ø—Ä–∞–≤–æ–≤–æ–π –∑–∞—â–∏—Ç—ã
‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫
‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π

–§–û–†–ú–ê–¢ –ê–ù–ê–õ–ò–ó–ê:
1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è** (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ)
2. **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è** (—É—Å–∏–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π)
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫** (–ø–æ–≤—ã—à–µ–Ω–∏–µ —è—Å–Ω–æ—Å—Ç–∏)
4. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏** (—Å–Ω–∏–∂–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤)
5. **–ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π**""",

            "correspondence_analysis": """

–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –ê–ù–ê–õ–ò–ó –ü–ï–†–ï–ü–ò–°–ö–ò –ò –ö–û–ú–ú–£–ù–ò–ö–ê–¶–ò–ô
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏
‚Ä¢ –í—ã—è–≤–ª–µ–Ω–∏–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–π –±–∞–∑—ã
‚Ä¢ –û—Ü–µ–Ω–∫–∞ –ø—Ä–∞–≤–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π —Å—Ç–æ—Ä–æ–Ω
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä

–§–û–†–ú–ê–¢ –ê–ù–ê–õ–ò–ó–ê:
1. **–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∞–≤–æ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã** –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ
2. **–î–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å** –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
3. **–ü–æ–∑–∏—Ü–∏–∏ —Å—Ç–æ—Ä–æ–Ω** –∏ –∏—Ö –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
4. **–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è** (–µ—Å–ª–∏ –µ—Å—Ç—å)
5. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–∏–º –¥–µ–π—Å—Ç–≤–∏—è–º**"""
        }
        
        return base_prompt + analysis_specific.get(analysis_type, analysis_specific["law_compliance"])

    def _format_document_analysis_request(
        self, 
        document_text: str, 
        analysis_type: str, 
        filename: str
    ) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        """
        analysis_names = {
            "law_compliance": "–ü–†–û–í–ï–†–ö–ê –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø –ó–ê–ö–û–ù–£",
            "error_detection": "–ü–û–ò–°–ö –û–®–ò–ë–û–ö –ò –ù–ï–î–û–ß–ï–¢–û–í", 
            "risk_assessment": "–û–¶–ï–ù–ö–ê –Æ–†–ò–î–ò–ß–ï–°–ö–ò–• –†–ò–°–ö–û–í",
            "recommendations": "–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ",
            "correspondence_analysis": "–ê–ù–ê–õ–ò–ó –ü–ï–†–ï–ü–ò–°–ö–ò"
        }
        
        analysis_name = analysis_names.get(analysis_type, "–ê–ù–ê–õ–ò–ó –î–û–ö–£–ú–ï–ù–¢–ê")
        
        # –û–±—Ä–µ–∑–∞–µ–º —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–æ—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞)
        max_text_length = 8000  # –ü—Ä–∏–º–µ—Ä–Ω–æ 2000 —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        if len(document_text) > max_text_length:
            document_text = document_text[:max_text_length] + "\n\n[–¢–ï–ö–°–¢ –û–ë–†–ï–ó–ê–ù –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê]"
        
        formatted_request = f"""–¢–ò–ü –ê–ù–ê–õ–ò–ó–ê: {analysis_name}
–§–ê–ô–õ: {filename}
–î–õ–ò–ù–ê –¢–ï–ö–°–¢–ê: {len(document_text)} —Å–∏–º–≤–æ–ª–æ–≤

–¢–ï–ö–°–¢ –î–û–ö–£–ú–ï–ù–¢–ê –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:
{'='*50}
{document_text}
{'='*50}

–ü—Ä–æ–≤–µ–¥–∏ —Ç—â–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É —Ç–∏–ø—É –∞–Ω–∞–ª–∏–∑–∞. 
–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –∏ –±—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º."""
        
        return formatted_request

    def _format_document_analysis_response(
        self, 
        analysis_content: str, 
        analysis_type: str, 
        filename: str
    ) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        """
        analysis_icons = {
            "law_compliance": "‚öñÔ∏è",
            "error_detection": "üîç", 
            "risk_assessment": "‚ö†Ô∏è",
            "recommendations": "üí°",
            "correspondence_analysis": "üìß"
        }
        
        analysis_names = {
            "law_compliance": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∑–∞–∫–æ–Ω—É",
            "error_detection": "–ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ –∏ –Ω–µ–¥–æ—á–µ—Ç–æ–≤", 
            "risk_assessment": "–û—Ü–µ–Ω–∫–∞ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤",
            "recommendations": "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é",
            "correspondence_analysis": "–ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–ø–∏—Å–∫–∏"
        }
        
        icon = analysis_icons.get(analysis_type, "üìã")
        name = analysis_names.get(analysis_type, "–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞")
        
        header = f"""{icon} **{name}**
üìÑ **–§–∞–π–ª:** {filename}
ü§ñ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ:** AI-–Æ—Ä–∏—Å—Ç

{'='*40}

"""
        
        footer = f"""

{'='*40}
üí° **–í–∞–∂–Ω–æ:** –î–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–æ—Å–∏—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –≤–∞–∂–Ω—ã—Ö –ø—Ä–∞–≤–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –ø—Ä–∞–∫—Ç–∏–∫—É—é—â–∏–º —é—Ä–∏—Å—Ç–æ–º.

üîÑ –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥—Ä—É–≥–æ–π —Ç–∏–ø –∞–Ω–∞–ª–∏–∑–∞ —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞? –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /analyze"""
        
        return header + analysis_content + footer

    def _get_document_analysis_error_response(self, analysis_type: str) -> str:
        """
        –†–µ–∑–µ—Ä–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        """
        analysis_names = {
            "law_compliance": "–ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∑–∞–∫–æ–Ω—É",
            "error_detection": "–ø–æ–∏—Å–∫–∞ –æ—à–∏–±–æ–∫", 
            "risk_assessment": "–æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤",
            "recommendations": "—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π",
            "correspondence_analysis": "–∞–Ω–∞–ª–∏–∑–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∏"
        }
        
        analysis_name = analysis_names.get(analysis_type, "–∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞")
        
        return f"""‚ùå **–û—à–∏–±–∫–∞ {analysis_name}**

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞.

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –∏–ª–∏ —Å–ª–æ–∂–Ω—ã–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å AI-—Å–µ—Ä–≤–∏—Å–æ–º
‚Ä¢ –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ –∫–æ–¥–∏—Ä–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–µ–º—ã–π –∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
‚Ä¢ –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç

üîÑ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ —Å –∫–æ–º–∞–Ω–¥–æ–π /analyze"""


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∏–µ–Ω—Ç–∞
gigachat_client = GigaChatClient()